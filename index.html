<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GST Invoice Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            sendPasswordResetEmail 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            doc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            orderBy, 
            query, 
            where,
            enableIndexedDbPersistence,
            setDoc,
            getDoc,
            Timestamp
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "your-api-key-here",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "your-app-id"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Enable offline persistence
        try {
            await enableIndexedDbPersistence(db);
        } catch (err) {
            console.log('Offline persistence failed:', err);
        }

        // App constants
        const APP_ID = 'my-gst-app-500b5';
        let currentUser = null;
        let currentPage = 'dashboard';
        let appData = {
            clients: [],
            products: [],
            invoices: [],
            expenses: [],
            profile: {}
        };

        // Utility functions
        function getUserBasePath(uid) {
            return `artifacts/${APP_ID}/users/${uid}`;
        }

        function showLoading(show = true) {
            const loader = document.getElementById('loading');
            if (loader) {
                loader.classList.toggle('hidden', !show);
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded shadow-lg z-50';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded shadow-lg z-50';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR'
            }).format(amount);
        }

        function formatDate(date) {
            if (!date) return '';
            const d = date.toDate ? date.toDate() : new Date(date);
            return d.toLocaleDateString('en-IN');
        }

        // Authentication functions
        async function signUp(email, password) {
            try {
                showLoading();
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Create default profile
                const profileRef = doc(db, `${getUserBasePath(user.uid)}/profile/details`);
                await setDoc(profileRef, {
                    companyName: 'My Company',
                    companyAddress: '',
                    companyGstin: '',
                    companyState: '',
                    companyLogoUrl: '',
                    companyUpiId: '',
                    createdAt: Timestamp.now()
                });
                
                showSuccess('Account created successfully!');
            } catch (error) {
                showError(error.message);
            } finally {
                showLoading(false);
            }
        }

        async function signIn(email, password) {
            try {
                showLoading();
                await signInWithEmailAndPassword(auth, email, password);
                showSuccess('Signed in successfully!');
            } catch (error) {
                showError(error.message);
            } finally {
                showLoading(false);
            }
        }

        async function resetPassword(email) {
            try {
                await sendPasswordResetEmail(auth, email);
                showSuccess('Password reset email sent!');
            } catch (error) {
                showError(error.message);
            }
        }

        async function signOutUser() {
            try {
                await signOut(auth);
                showSuccess('Signed out successfully!');
            } catch (error) {
                showError(error.message);
            }
        }

        // Data management functions
        async function loadUserData() {
            if (!currentUser) return;
            
            const basePath = getUserBasePath(currentUser.uid);
            
            try {
                showLoading();
                
                // Load profile
                const profileDoc = await getDoc(doc(db, `${basePath}/profile/details`));
                if (profileDoc.exists()) {
                    appData.profile = profileDoc.data();
                }
                
                // Set up real-time listeners
                setupRealtimeListeners();
                
            } catch (error) {
                showError('Failed to load data: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function setupRealtimeListeners() {
            if (!currentUser) return;
            
            const basePath = getUserBasePath(currentUser.uid);
            
            // Clients listener
            onSnapshot(collection(db, `${basePath}/clients`), (snapshot) => {
                appData.clients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateUI();
            });
            
            // Products listener
            onSnapshot(collection(db, `${basePath}/products`), (snapshot) => {
                appData.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateUI();
            });
            
            // Invoices listener
            onSnapshot(query(collection(db, `${basePath}/invoices`), orderBy('invoiceDate', 'desc')), (snapshot) => {
                appData.invoices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateUI();
            });
            
            // Expenses listener
            onSnapshot(query(collection(db, `${basePath}/expenses`), orderBy('date', 'desc')), (snapshot) => {
                appData.expenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateUI();
            });
        }

        // CRUD operations
        async function addClient(clientData) {
            try {
                await addDoc(collection(db, `${getUserBasePath(currentUser.uid)}/clients`), clientData);
                showSuccess('Client added successfully!');
            } catch (error) {
                showError('Failed to add client: ' + error.message);
            }
        }

        async function updateClient(clientId, clientData) {
            try {
                await updateDoc(doc(db, `${getUserBasePath(currentUser.uid)}/clients/${clientId}`), clientData);
                showSuccess('Client updated successfully!');
            } catch (error) {
                showError('Failed to update client: ' + error.message);
            }
        }

        async function deleteClient(clientId) {
            try {
                await deleteDoc(doc(db, `${getUserBasePath(currentUser.uid)}/clients/${clientId}`));
                showSuccess('Client deleted successfully!');
            } catch (error) {
                showError('Failed to delete client: ' + error.message);
            }
        }

        async function addProduct(productData) {
            try {
                await addDoc(collection(db, `${getUserBasePath(currentUser.uid)}/products`), productData);
                showSuccess('Product added successfully!');
            } catch (error) {
                showError('Failed to add product: ' + error.message);
            }
        }

        async function updateProduct(productId, productData) {
            try {
                await updateDoc(doc(db, `${getUserBasePath(currentUser.uid)}/products/${productId}`), productData);
                showSuccess('Product updated successfully!');
            } catch (error) {
                showError('Failed to update product: ' + error.message);
            }
        }

        async function deleteProduct(productId) {
            try {
                await deleteDoc(doc(db, `${getUserBasePath(currentUser.uid)}/products/${productId}`));
                showSuccess('Product deleted successfully!');
            } catch (error) {
                showError('Failed to delete product: ' + error.message);
            }
        }

        async function addExpense(expenseData) {
            try {
                await addDoc(collection(db, `${getUserBasePath(currentUser.uid)}/expenses`), expenseData);
                showSuccess('Expense added successfully!');
            } catch (error) {
                showError('Failed to add expense: ' + error.message);
            }
        }

        async function updateExpense(expenseId, expenseData) {
            try {
                await updateDoc(doc(db, `${getUserBasePath(currentUser.uid)}/expenses/${expenseId}`), expenseData);
                showSuccess('Expense updated successfully!');
            } catch (error) {
                showError('Failed to update expense: ' + error.message);
            }
        }

        async function deleteExpense(expenseId) {
            try {
                await deleteDoc(doc(db, `${getUserBasePath(currentUser.uid)}/expenses/${expenseId}`));
                showSuccess('Expense deleted successfully!');
            } catch (error) {
                showError('Failed to delete expense: ' + error.message);
            }
        }

        async function saveInvoice(invoiceData, invoiceId = null) {
            try {
                if (invoiceId) {
                    await updateDoc(doc(db, `${getUserBasePath(currentUser.uid)}/invoices/${invoiceId}`), invoiceData);
                    showSuccess('Invoice updated successfully!');
                } else {
                    await addDoc(collection(db, `${getUserBasePath(currentUser.uid)}/invoices`), invoiceData);
                    showSuccess('Invoice created successfully!');
                }
            } catch (error) {
                showError('Failed to save invoice: ' + error.message);
            }
        }

        async function deleteInvoice(invoiceId) {
            try {
                await deleteDoc(doc(db, `${getUserBasePath(currentUser.uid)}/invoices/${invoiceId}`));
                showSuccess('Invoice deleted successfully!');
            } catch (error) {
                showError('Failed to delete invoice: ' + error.message);
            }
        }

        async function updateProfile(profileData) {
            try {
                await updateDoc(doc(db, `${getUserBasePath(currentUser.uid)}/profile/details`), profileData);
                appData.profile = { ...appData.profile, ...profileData };
                showSuccess('Profile updated successfully!');
                updateUI();
            } catch (error) {
                showError('Failed to update profile: ' + error.message);
            }
        }

        // UI functions
        function renderAuthView() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center px-4">
                    <div class="max-w-md w-full space-y-8">
                        <div class="text-center">
                            <h2 class="mt-6 text-3xl font-bold text-gray-900">GST Invoice Pro</h2>
                            <p class="mt-2 text-sm text-gray-600">Professional invoicing & financial management</p>
                        </div>
                        <div class="bg-white rounded-lg shadow-lg p-8">
                            <div class="flex border-b mb-6" id="auth-tabs">
                                <button class="flex-1 py-2 px-4 text-sm font-medium border-b-2 border-blue-500 text-blue-600" onclick="switchAuthTab('signin')">Sign In</button>
                                <button class="flex-1 py-2 px-4 text-sm font-medium text-gray-500 hover:text-gray-700" onclick="switchAuthTab('signup')">Sign Up</button>
                            </div>
                            
                            <form id="signin-form" class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Email</label>
                                    <input type="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="signin-email">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Password</label>
                                    <input type="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="signin-password">
                                </div>
                                <div class="flex items-center justify-between">
                                    <button type="button" class="text-sm text-blue-600 hover:text-blue-500" onclick="showForgotPassword()">Forgot password?</button>
                                </div>
                                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    Sign In
                                </button>
                            </form>
                            
                            <form id="signup-form" class="space-y-6 hidden">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Email</label>
                                    <input type="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="signup-email">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Password</label>
                                    <input type="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="signup-password">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Confirm Password</label>
                                    <input type="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="signup-confirm-password">
                                </div>
                                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    Sign Up
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMainApp() {
            return `
                <div class="flex h-screen bg-gray-100">
                    <!-- Sidebar -->
                    <div class="hidden md:flex md:flex-shrink-0">
                        <div class="flex flex-col w-64 bg-white shadow-lg">
                            <div class="flex items-center justify-center h-16 px-4 bg-blue-600 text-white">
                                <h1 class="text-xl font-bold">GST Invoice Pro</h1>
                            </div>
                            <div class="flex flex-col flex-1 overflow-y-auto">
                                <nav class="flex-1 px-2 py-4 space-y-1">
                                    <a href="#" class="nav-item ${currentPage === 'dashboard' ? 'active' : ''}" onclick="navigateTo('dashboard')">
                                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                                        </svg>
                                        Dashboard
                                    </a>
                                    <a href="#" class="nav-item ${currentPage === 'invoices' ? 'active' : ''}" onclick="navigateTo('invoices')">
                                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        Invoices
                                    </a>
                                    <a href="#" class="nav-item ${currentPage === 'clients' ? 'active' : ''}" onclick="navigateTo('clients')">
                                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                        </svg>
                                        Clients
                                    </a>
                                    <a href="#" class="nav-item ${currentPage === 'products' ? 'active' : ''}" onclick="navigateTo('products')">
                                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                                        </svg>
                                        Products
                                    </a>
                                    <a href="#" class="nav-item ${currentPage === 'expenses' ? 'active' : ''}" onclick="navigateTo('expenses')">
                                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        Expenses
                                    </a>
                                    <a href="#" class="nav-item ${currentPage === 'settings' ? 'active' : ''}" onclick="navigateTo('settings')">
                                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        </svg>
                                        Settings
                                    </a>
                                </nav>
                                <div class="px-2 py-4 border-t">
                                    <div class="text-xs text-gray-500 mb-2">${appData.profile.companyName || 'My Company'}</div>
                                    <div class="text-xs text-gray-400 mb-2">${currentUser?.email}</div>
                                    <button onclick="signOutUser()" class="w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-md">
                                        Sign Out
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mobile menu button -->
                    <div class="md:hidden fixed top-4 left-4 z-50">
                        <button onclick="toggleMobileMenu()" class="bg-white p-2 rounded-md shadow-lg">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Mobile menu -->
                    <div id="mobile-menu" class="md:hidden fixed inset-0 z-40 hidden">
                        <div class="fixed inset-0 bg-black opacity-50" onclick="toggleMobileMenu()"></div>
                        <div class="fixed left-0 top-0 bottom-0 w-64 bg-white shadow-lg">
                            <div class="flex items-center justify-between h-16 px-4 bg-blue-600 text-white">
                                <h1 class="text-xl font-bold">GST Invoice Pro</h1>
                                <button onclick="toggleMobileMenu()" class="text-white">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            <nav class="px-2 py-4 space-y-1">
                                <a href="#" class="nav-item ${currentPage === 'dashboard' ? 'active' : ''}" onclick="navigateTo('dashboard'); toggleMobileMenu()">Dashboard</a>
                                <a href="#" class="nav-item ${currentPage === 'invoices' ? 'active' : ''}" onclick="navigateTo('invoices'); toggleMobileMenu()">Invoices</a>
                                <a href="#" class="nav-item ${currentPage === 'clients' ? 'active' : ''}" onclick="navigateTo('clients'); toggleMobileMenu()">Clients</a>
                                <a href="#" class="nav-item ${currentPage === 'products' ? 'active' : ''}" onclick="navigateTo('products'); toggleMobileMenu()">Products</a>
                                <a href="#" class="nav-item ${currentPage === 'expenses' ? 'active' : ''}" onclick="navigateTo('expenses'); toggleMobileMenu()">Expenses</a>
                                <a href="#" class="nav-item ${currentPage === 'settings' ? 'active' : ''}" onclick="navigateTo('settings'); toggleMobileMenu()">Settings</a>
                            </nav>
                            <div class="absolute bottom-4 left-2 right-2 border-t pt-4">
                                <div class="text-xs text-gray-500 mb-2 px-3">${appData.profile.companyName || 'My Company'}</div>
                                <div class="text-xs text-gray-400 mb-2 px-3">${currentUser?.email}</div>
                                <button onclick="signOutUser()" class="w-full text-left px-3 py-2 text-sm text-red-600 hover:bg-red-50 rounded-md">
                                    Sign Out
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Main content -->
                    <div class="flex-1 overflow-auto">
                        <main class="p-4 md:p-8">
                            <div id="main-content">
                                ${renderPageContent()}
                            </div>
                        </main>
                    </div>
                </div>
            `;
        }

        function renderPageContent() {
            switch (currentPage) {
                case 'dashboard':
                    return renderDashboard();
                case 'invoices':
                    return renderInvoices();
                case 'invoice-form':
                    return renderInvoiceForm();
                case 'clients':
                    return renderClients();
                case 'products':
                    return renderProducts();
                case 'expenses':
                    return renderExpenses();
                case 'settings':
                    return renderSettings();
                default:
                    return renderDashboard();
            }
        }

        function renderDashboard() {
            const totalRevenue = appData.invoices
                .filter(inv => inv.status === 'paid')
                .reduce((sum, inv) => sum + (inv.total || 0), 0);
            
            const totalExpenses = appData.expenses
                .reduce((sum, exp) => sum + (exp.amount || 0), 0);
            
            const netProfit = totalRevenue - totalExpenses;
            
            const recentInvoices = appData.invoices.slice(0, 5);

            return `
                <div class="space-y-6">
                    <h1 class="text-3xl font-bold text-gray-900">Dashboard</h1>
                    
                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">Total Revenue</dt>
                                        <dd class="text-lg font-medium text-gray-900">${formatCurrency(totalRevenue)}</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center">
                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">Total Expenses</dt>
                                        <dd class="text-lg font-medium text-gray-900">${formatCurrency(totalExpenses)}</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <div class="w-8 h-8 ${netProfit >= 0 ? 'bg-blue-500' : 'bg-orange-500'} rounded-full flex items-center justify-center">
                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div class="ml-5 w-0 flex-1">
                                    <dl>
                                        <dt class="text-sm font-medium text-gray-500 truncate">Net Profit</dt>
                                        <dd class="text-lg font-medium ${netProfit >= 0 ? 'text-gray-900' : 'text-red-600'}">${formatCurrency(netProfit)}</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chart and Recent Invoices -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">Income vs Expenses</h3>
                            <canvas id="financial-chart" width="400" height="300"></canvas>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-medium text-gray-900">Recent Invoices</h3>
                                <button onclick="navigateTo('invoices')" class="text-blue-600 hover:text-blue-500 text-sm font-medium">View all</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invoice #</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${recentInvoices.map(invoice => {
                                            const client = appData.clients.find(c => c.id === invoice.clientId);
                                            return `
                                                <tr>
                                                    <td class="px-4 py-2 text-sm text-gray-900">${invoice.invoiceNumber}</td>
                                                    <td class="px-4 py-2 text-sm text-gray-900">${client?.name || 'Unknown'}</td>
                                                    <td class="px-4 py-2 text-sm text-gray-900">${formatCurrency(invoice.total || 0)}</td>
                                                    <td class="px-4 py-2">
                                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(invoice.status)}">
                                                            ${invoice.status || 'pending'}
                                                        </span>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                                ${recentInvoices.length === 0 ? '<p class="text-gray-500 text-center py-4">No invoices yet</p>' : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderInvoices() {
            return `
                <div class="space-y-6">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                        <h1 class="text-3xl font-bold text-gray-900">Invoices</h1>
                        <button onclick="navigateTo('invoice-form')" class="mt-4 sm:mt-0 inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Create Invoice
                        </button>
                    </div>
                    
                    <div class="bg-white shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <div class="mb-4">
                                <input type="text" placeholder="Search invoices..." id="invoice-search" class="block w-full sm:w-64 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200" id="invoices-table-body">
                                        ${renderInvoicesTable()}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderInvoicesTable() {
            const searchTerm = document.getElementById('invoice-search')?.value.toLowerCase() || '';
            const filteredInvoices = appData.invoices.filter(invoice => {
                const client = appData.clients.find(c => c.id === invoice.clientId);
                return invoice.invoiceNumber?.toLowerCase().includes(searchTerm) ||
                       client?.name?.toLowerCase().includes(searchTerm) ||
                       invoice.status?.toLowerCase().includes(searchTerm);
            });

            if (filteredInvoices.length === 0) {
                return '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No invoices found</td></tr>';
            }

            return filteredInvoices.map(invoice => {
                const client = appData.clients.find(c => c.id === invoice.clientId);
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${invoice.invoiceNumber}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${client?.name || 'Unknown'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(invoice.invoiceDate)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(invoice.dueDate)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(invoice.total || 0)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(invoice.status)}">
                                ${invoice.status || 'pending'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            <button onclick="editInvoice('${invoice.id}')" class="text-blue-600 hover:text-blue-900">Edit</button>
                            <button onclick="viewInvoice('${invoice.id}')" class="text-green-600 hover:text-green-900">View</button>
                            <button onclick="markAsPaid('${invoice.id}')" class="text-yellow-600 hover:text-yellow-900">Mark Paid</button>
                            <button onclick="deleteInvoiceConfirm('${invoice.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderInvoiceForm() {
            const editingInvoice = window.editingInvoice;
            const isEditing = !!editingInvoice;
            
            return `
                <div class="space-y-6">
                    <div class="flex items-center justify-between">
                        <h1 class="text-3xl font-bold text-gray-900">${isEditing ? 'Edit Invoice' : 'Create Invoice'}</h1>
                        <button onclick="navigateTo('invoices')" class="text-gray-600 hover:text-gray-900">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="invoice-form" class="bg-white shadow rounded-lg p-6 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Invoice Number</label>
                                <input type="text" id="invoice-number" value="${editingInvoice?.invoiceNumber || generateInvoiceNumber()}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Invoice Date</label>
                                <input type="date" id="invoice-date" value="${editingInvoice ? formatDateForInput(editingInvoice.invoiceDate) : new Date().toISOString().split('T')[0]}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Due Date</label>
                                <input type="date" id="due-date" value="${editingInvoice ? formatDateForInput(editingInvoice.dueDate) : ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Client</label>
                            <select id="client-select" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                                <option value="">Select a client</option>
                                ${appData.clients.map(client => 
                                    `<option value="${client.id}" ${editingInvoice?.clientId === client.id ? 'selected' : ''}>${client.name}</option>`
                                ).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-medium text-gray-900">Line Items</h3>
                                <button type="button" onclick="addLineItem()" class="inline-flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    Add Item
                                </button>
                            </div>
                            
                            <div id="line-items" class="space-y-4">
                                ${editingInvoice ? editingInvoice.items.map((item, index) => renderLineItem(item, index)).join('') : renderLineItem({}, 0)}
                            </div>
                        </div>
                        
                        <div class="border-t pt-4">
                            <div class="flex justify-end">
                                <div class="w-64 space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-sm text-gray-600">Subtotal:</span>
                                        <span id="subtotal" class="text-sm font-medium">₹0.00</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm text-gray-600">Total Tax:</span>
                                        <span id="total-tax" class="text-sm font-medium">₹0.00</span>
                                    </div>
                                    <div class="flex justify-between text-lg font-bold border-t pt-2">
                                        <span>Total:</span>
                                        <span id="grand-total">₹0.00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-4">
                            <button type="button" onclick="navigateTo('invoices')" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="submit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                                ${isEditing ? 'Update Invoice' : 'Save Invoice'}
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        function renderLineItem(item = {}, index) {
            return `
                <div class="line-item border rounded-lg p-4 bg-gray-50" data-index="${index}">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Description</label>
                            <select class="product-select mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" onchange="selectProduct(this, ${index})">
                                <option value="">Select product or enter manually</option>
                                ${appData.products.map(product => 
                                    `<option value="${product.id}" data-price="${product.price}" data-gst="${product.gstRate}" ${item.productId === product.id ? 'selected' : ''}>${product.name}</option>`
                                ).join('')}
                            </select>
                            <input type="text" class="description-input mt-2 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Or enter description manually" value="${item.name || ''}" onchange="calculateLineTotal(${index})">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Quantity</label>
                            <input type="number" class="quantity-input mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" min="1" value="${item.quantity || 1}" onchange="calculateLineTotal(${index})">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Price</label>
                            <input type="number" class="price-input mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" min="0" step="0.01" value="${item.price || ''}" onchange="calculateLineTotal(${index})">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">GST Rate (%)</label>
                            <input type="number" class="gst-input mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" min="0" max="100" step="0.01" value="${item.gstRate || 18}" onchange="calculateLineTotal(${index})">
                        </div>
                    </div>
                    <div class="flex justify-between items-center mt-4">
                        <div class="text-sm text-gray-600">
                            Line Total: <span class="line-total font-medium">₹0.00</span>
                        </div>
                        ${index > 0 ? `<button type="button" onclick="removeLineItem(${index})" class="text-red-600 hover:text-red-900 text-sm">Remove</button>` : ''}
                    </div>
                </div>
            `;
        }

        function renderClients() {
            return `
                <div class="space-y-6">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                        <h1 class="text-3xl font-bold text-gray-900">Clients</h1>
                        <button onclick="openClientModal()" class="mt-4 sm:mt-0 inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Add Client
                        </button>
                    </div>
                    
                    <div class="bg-white shadow rounded-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">GSTIN</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">State</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${appData.clients.map(client => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div>
                                                    <div class="text-sm font-medium text-gray-900">${client.name}</div>
                                                    <div class="text-sm text-gray-500">${client.address}</div>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${client.gstin || 'N/A'}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${client.state}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                                <button onclick="editClient('${client.id}')" class="text-blue-600 hover:text-blue-900">Edit</button>
                                                <button onclick="deleteClientConfirm('${client.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                    ${appData.clients.length === 0 ? '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No clients found</td></tr>' : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderProducts() {
            return `
                <div class="space-y-6">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                        <h1 class="text-3xl font-bold text-gray-900">Products & Services</h1>
                        <button onclick="openProductModal()" class="mt-4 sm:mt-0 inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Add Product
                        </button>
                    </div>
                    
                    <div class="bg-white shadow rounded-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">GST Rate</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${appData.products.map(product => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${product.name}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(product.price)}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${product.gstRate}%</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                                <button onclick="editProduct('${product.id}')" class="text-blue-600 hover:text-blue-900">Edit</button>
                                                <button onclick="deleteProductConfirm('${product.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                    ${appData.products.length === 0 ? '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No products found</td></tr>' : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderExpenses() {
            return `
                <div class="space-y-6">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                        <h1 class="text-3xl font-bold text-gray-900">Expenses</h1>
                        <button onclick="openExpenseModal()" class="mt-4 sm:mt-0 inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Add Expense
                        </button>
                    </div>
                    
                    <div class="bg-white shadow rounded-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${appData.expenses.map(expense => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(expense.date)}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${expense.category}</td>
                                            <td class="px-6 py-4 text-sm text-gray-900">${expense.description}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${formatCurrency(expense.amount)}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                                <button onclick="editExpense('${expense.id}')" class="text-blue-600 hover:text-blue-900">Edit</button>
                                                <button onclick="deleteExpenseConfirm('${expense.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                    ${appData.expenses.length === 0 ? '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No expenses found</td></tr>' : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSettings() {
            return `
                <div class="space-y-6">
                    <h1 class="text-3xl font-bold text-gray-900">Company Settings</h1>
                    
                    <form id="settings-form" class="bg-white shadow rounded-lg p-6 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Company Name</label>
                                <input type="text" id="company-name" value="${appData.profile.companyName || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">GSTIN</label>
                                <input type="text" id="company-gstin" value="${appData.profile.companyGstin || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Address</label>
                            <textarea id="company-address" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">${appData.profile.companyAddress || ''}</textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">State</label>
                                <input type="text" id="company-state" value="${appData.profile.companyState || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">UPI ID (for QR codes)</label>
                                <input type="text" id="company-upi" value="${appData.profile.companyUpiId || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Company Logo URL</label>
                            <input type="url" id="company-logo" value="${appData.profile.companyLogoUrl || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            <p class="mt-1 text-sm text-gray-500">Enter a URL to your company logo image</p>
                        </div>
                        
                        <div class="flex justify-end">
                            <button type="submit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                                Save Settings
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        // Helper functions
        function getStatusColor(status) {
            switch (status) {
                case 'paid':
                    return 'bg-green-100 text-green-800';
                case 'pending':
                    return 'bg-yellow-100 text-yellow-800';
                case 'overdue':
                    return 'bg-red-100 text-red-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        function generateInvoiceNumber() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const count = appData.invoices.length + 1;
            return `INV-${year}${month}-${String(count).padStart(4, '0')}`;
        }

        function formatDateForInput(date) {
            if (!date) return '';
            const d = date.toDate ? date.toDate() : new Date(date);
            return d.toISOString().split('T')[0];
        }

        // Global functions for HTML onclick handlers
        window.switchAuthTab = function(tab) {
            const signinForm = document.getElementById('signin-form');
            const signupForm = document.getElementById('signup-form');
            const tabs = document.querySelectorAll('#auth-tabs button');
            
            tabs.forEach(button => {
                button.classList.remove('border-blue-500', 'text-blue-600');
                button.classList.add('text-gray-500');
            });
            
            if (tab === 'signin') {
                signinForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
                tabs[0].classList.add('border-blue-500', 'text-blue-600');
                tabs[0].classList.remove('text-gray-500');
            } else {
                signinForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                tabs[1].classList.add('border-blue-500', 'text-blue-600');
                tabs[1].classList.remove('text-gray-500');
            }
        };

        window.showForgotPassword = function() {
            const email = prompt('Enter your email address:');
            if (email) {
                resetPassword(email);
            }
        };

        window.toggleMobileMenu = function() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        };

        window.navigateTo = function(page) {
            currentPage = page;
            window.editingInvoice = null;
            updateUI();
        };

        window.openClientModal = function(clientId = null) {
            const client = clientId ? appData.clients.find(c => c.id === clientId) : {};
            const isEditing = !!clientId;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">${isEditing ? 'Edit Client' : 'Add Client'}</h3>
                    <form id="client-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Name</label>
                            <input type="text" id="client-name" value="${client.name || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Address</label>
                            <textarea id="client-address" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">${client.address || ''}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">GSTIN</label>
                            <input type="text" id="client-gstin" value="${client.gstin || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">State</label>
                            <input type="text" id="client-state" value="${client.state || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="submit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                                ${isEditing ? 'Update' : 'Add'} Client
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.querySelector('#client-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const clientData = {
                    name: modal.querySelector('#client-name').value,
                    address: modal.querySelector('#client-address').value,
                    gstin: modal.querySelector('#client-gstin').value,
                    state: modal.querySelector('#client-state').value
                };
                
                if (isEditing) {
                    await updateClient(clientId, clientData);
                } else {
                    await addClient(clientData);
                }
                
                modal.remove();
            });
        };

        window.editClient = function(clientId) {
            openClientModal(clientId);
        };

        window.deleteClientConfirm = function(clientId) {
            if (confirm('Are you sure you want to delete this client?')) {
                deleteClient(clientId);
            }
        };

        window.openProductModal = function(productId = null) {
            const product = productId ? appData.products.find(p => p.id === productId) : {};
            const isEditing = !!productId;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">${isEditing ? 'Edit Product' : 'Add Product'}</h3>
                    <form id="product-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Name</label>
                            <input type="text" id="product-name" value="${product.name || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Price</label>
                            <input type="number" id="product-price" value="${product.price || ''}" min="0" step="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">GST Rate (%)</label>
                            <input type="number" id="product-gst" value="${product.gstRate || 18}" min="0" max="100" step="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="submit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                                ${isEditing ? 'Update' : 'Add'} Product
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.querySelector('#product-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const productData = {
                    name: modal.querySelector('#product-name').value,
                    price: parseFloat(modal.querySelector('#product-price').value),
                    gstRate: parseFloat(modal.querySelector('#product-gst').value)
                };
                
                if (isEditing) {
                    await updateProduct(productId, productData);
                } else {
                    await addProduct(productData);
                }
                
                modal.remove();
            });
        };

        window.editProduct = function(productId) {
            openProductModal(productId);
        };

        window.deleteProductConfirm = function(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                deleteProduct(productId);
            }
        };

        window.openExpenseModal = function(expenseId = null) {
            const expense = expenseId ? appData.expenses.find(e => e.id === expenseId) : {};
            const isEditing = !!expenseId;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">${isEditing ? 'Edit Expense' : 'Add Expense'}</h3>
                    <form id="expense-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" id="expense-date" value="${expense.date ? formatDateForInput(expense.date) : new Date().toISOString().split('T')[0]}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Category</label>
                            <input type="text" id="expense-category" value="${expense.category || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Description</label>
                            <textarea id="expense-description" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>${expense.description || ''}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Amount</label>
                            <input type="number" id="expense-amount" value="${expense.amount || ''}" min="0" step="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="submit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                                ${isEditing ? 'Update' : 'Add'} Expense
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            modal.querySelector('#expense-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const expenseData = {
                    date: Timestamp.fromDate(new Date(modal.querySelector('#expense-date').value)),
                    category: modal.querySelector('#expense-category').value,
                    description: modal.querySelector('#expense-description').value,
                    amount: parseFloat(modal.querySelector('#expense-amount').value)
                };
                
                if (isEditing) {
                    await updateExpense(expenseId, expenseData);
                } else {
                    await addExpense(expenseData);
                }
                
                modal.remove();
            });
        };

        window.editExpense = function(expenseId) {
            openExpenseModal(expenseId);
        };

        window.deleteExpenseConfirm = function(expenseId) {
            if (confirm('Are you sure you want to delete this expense?')) {
                deleteExpense(expenseId);
            }
        };

        window.editInvoice = function(invoiceId) {
            window.editingInvoice = appData.invoices.find(inv => inv.id === invoiceId);
            navigateTo('invoice-form');
        };

        window.viewInvoice = function(invoiceId) {
            const invoice = appData.invoices.find(inv => inv.id === invoiceId);
            if (invoice) {
                showInvoicePreview(invoice);
            }
        };

        window.markAsPaid = function(invoiceId) {
            const invoice = appData.invoices.find(inv => inv.id === invoiceId);
            if (invoice && confirm('Mark this invoice as paid?')) {
                saveInvoice({ ...invoice, status: 'paid' }, invoiceId);
            }
        };

        window.deleteInvoiceConfirm = function(invoiceId) {
            if (confirm('Are you sure you want to delete this invoice?')) {
                deleteInvoice(invoiceId);
            }
        };

        window.addLineItem = function() {
            const container = document.getElementById('line-items');
            const itemCount = container.children.length;
            const newItem = document.createElement('div');
            newItem.innerHTML = renderLineItem({}, itemCount);
            container.appendChild(newItem.firstElementChild);
            calculateInvoiceTotal();
        };

        window.removeLineItem = function(index) {
            const item = document.querySelector(`[data-index="${index}"]`);
            if (item) {
                item.remove();
                calculateInvoiceTotal();
            }
        };

        window.selectProduct = function(select, index) {
            const option = select.selectedOptions[0];
            const lineItem = select.closest('.line-item');
            
            if (option.value) {
                lineItem.querySelector('.description-input').value = option.textContent;
                lineItem.querySelector('.price-input').value = option.dataset.price;
                lineItem.querySelector('.gst-input').value = option.dataset.gst;
            }
            
            calculateLineTotal(index);
        };

        window.calculateLineTotal = function(index) {
            const lineItem = document.querySelector(`[data-index="${index}"]`);
            if (!lineItem) return;
            
            const quantity = parseFloat(lineItem.querySelector('.quantity-input').value) || 0;
            const price = parseFloat(lineItem.querySelector('.price-input').value) || 0;
            const gstRate = parseFloat(lineItem.querySelector('.gst-input').value) || 0;
            
            const subtotal = quantity * price;
            const gstAmount = subtotal * (gstRate / 100);
            const total = subtotal + gstAmount;
            
            lineItem.querySelector('.line-total').textContent = formatCurrency(total);
            calculateInvoiceTotal();
        };

        function calculateInvoiceTotal() {
            let subtotal = 0;
            let totalTax = 0;
            
            document.querySelectorAll('.line-item').forEach(item => {
                const quantity = parseFloat(item.querySelector('.quantity-input').value) || 0;
                const price = parseFloat(item.querySelector('.price-input').value) || 0;
                const gstRate = parseFloat(item.querySelector('.gst-input').value) || 0;
                
                const itemSubtotal = quantity * price;
                const itemTax = itemSubtotal * (gstRate / 100);
                
                subtotal += itemSubtotal;
                totalTax += itemTax;
            });
            
            const grandTotal = subtotal + totalTax;
            
            document.getElementById('subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('total-tax').textContent = formatCurrency(totalTax);
            document.getElementById('grand-total').textContent = formatCurrency(grandTotal);
        }

        function showInvoicePreview(invoice) {
            const client = appData.clients.find(c => c.id === invoice.clientId);
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            // Generate QR code for UPI payment
            let qrCodeDataURL = '';
            if (appData.profile.companyUpiId && invoice.total) {
                const qr = qrcode(0, 'M');
                const upiString = `upi://pay?pa=${appData.profile.companyUpiId}&am=${invoice.total}&cu=INR&tn=Payment for Invoice ${invoice.invoiceNumber}`;
                qr.addData(upiString);
                qr.make();
                qrCodeDataURL = qr.createDataURL(4);
            }
            
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-full overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Invoice Preview</h3>
                        <div class="space-x-2">
                            <button onclick="printInvoice('${invoice.id}')" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Print</button>
                            <button onclick="downloadInvoicePDF('${invoice.id}')" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Download PDF</button>
                            <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Close</button>
                        </div>
                    </div>
                    
                    <div id="invoice-content" class="bg-white p-8 border" style="width: 210mm; min-height: 297mm; margin: 0 auto;">
                        <!-- Invoice Header -->
                        <div class="flex justify-between items-start mb-8">
                            <div>
                                ${appData.profile.companyLogoUrl ? `<img src="${appData.profile.companyLogoUrl}" alt="Company Logo" class="h-16 mb-4">` : ''}
                                <h1 class="text-2xl font-bold text-gray-900">${appData.profile.companyName || 'My Company'}</h1>
                                <div class="text-sm text-gray-600 mt-2">
                                    ${appData.profile.companyAddress ? `<p>${appData.profile.companyAddress}</p>` : ''}
                                    ${appData.profile.companyGstin ? `<p>GSTIN: ${appData.profile.companyGstin}</p>` : ''}
                                    ${appData.profile.companyState ? `<p>State: ${appData.profile.companyState}</p>` : ''}
                                </div>
                            </div>
                            <div class="text-right">
                                <h2 class="text-xl font-bold text-gray-900">INVOICE</h2>
                                <div class="text-sm text-gray-600 mt-2">
                                    <p><strong>Invoice #:</strong> ${invoice.invoiceNumber}</p>
                                    <p><strong>Date:</strong> ${formatDate(invoice.invoiceDate)}</p>
                                    <p><strong>Due Date:</strong> ${formatDate(invoice.dueDate)}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Client Details -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Bill To:</h3>
                            <div class="text-sm">
                                <p class="font-medium">${client?.name || 'Unknown Client'}</p>
                                ${client?.address ? `<p class="text-gray-600">${client.address}</p>` : ''}
                                ${client?.gstin ? `<p class="text-gray-600">GSTIN: ${client.gstin}</p>` : ''}
                                ${client?.state ? `<p class="text-gray-600">State: ${client.state}</p>` : ''}
                            </div>
                        </div>
                        
                        <!-- Invoice Items -->
                        <div class="mb-8">
                            <table class="w-full border-collapse border border-gray-300">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="border border-gray-300 px-4 py-2 text-left">Description</th>
                                        <th class="border border-gray-300 px-4 py-2 text-center">Qty</th>
                                        <th class="border border-gray-300 px-4 py-2 text-right">Rate</th>
                                        <th class="border border-gray-300 px-4 py-2 text-right">GST %</th>
                                        <th class="border border-gray-300 px-4 py-2 text-right">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${invoice.items?.map(item => {
                                        const itemTotal = item.quantity * item.price;
                                        const gstAmount = itemTotal * (item.gstRate / 100);
                                        return `
                                            <tr>
                                                <td class="border border-gray-300 px-4 py-2">${item.name}</td>
                                                <td class="border border-gray-300 px-4 py-2 text-center">${item.quantity}</td>
                                                <td class="border border-gray-300 px-4 py-2 text-right">${formatCurrency(item.price)}</td>
                                                <td class="border border-gray-300 px-4 py-2 text-right">${item.gstRate}%</td>
                                                <td class="border border-gray-300 px-4 py-2 text-right">${formatCurrency(itemTotal + gstAmount)}</td>
                                            </tr>
                                        `;
                                    }).join('') || '<tr><td colspan="5" class="border border-gray-300 px-4 py-2 text-center">No items</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Totals -->
                        <div class="flex justify-end mb-8">
                            <div class="w-64">
                                <div class="flex justify-between border-b py-2">
                                    <span>Subtotal:</span>
                                    <span>${formatCurrency(invoice.subtotal || 0)}</span>
                                </div>
                                <div class="flex justify-between border-b py-2">
                                    <span>Total GST:</span>
                                    <span>${formatCurrency(invoice.tax || 0)}</span>
                                </div>
                                <div class="flex justify-between font-bold text-lg py-2">
                                    <span>Total:</span>
                                    <span>${formatCurrency(invoice.total || 0)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Payment QR Code -->
                        ${qrCodeDataURL ? `
                            <div class="flex justify-center mb-8">
                                <div class="text-center">
                                    <img src="${qrCodeDataURL}" alt="UPI QR Code" class="mx-auto mb-2" style="width: 120px; height: 120px;">
                                    <p class="text-sm text-gray-600">Scan to pay via UPI</p>
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Footer -->
                        <div class="text-center text-sm text-gray-500 border-t pt-4">
                            <p>Thank you for your business!</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        window.printInvoice = function(invoiceId) {
            const content = document.getElementById('invoice-content');
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Invoice</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
                            .text-2xl { font-size: 1.5rem; }
                            .text-xl { font-size: 1.25rem; }
                            .text-lg { font-size: 1.125rem; }
                            .text-sm { font-size: 0.875rem; }
                            .font-bold { font-weight: bold; }
                            .font-semibold { font-weight: 600; }
                            .font-medium { font-weight: 500; }
                            .text-gray-900 { color: #111827; }
                            .text-gray-600 { color: #4b5563; }
                            .text-gray-500 { color: #6b7280; }
                            .mb-8 { margin-bottom: 2rem; }
                            .mb-4 { margin-bottom: 1rem; }
                            .mb-2 { margin-bottom: 0.5rem; }
                            .mt-2 { margin-top: 0.5rem; }
                            .p-8 { padding: 2rem; }
                            .px-4 { padding-left: 1rem; padding-right: 1rem; }
                            .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
                            .pt-4 { padding-top: 1rem; }
                            .border { border: 1px solid #d1d5db; }
                            .border-b { border-bottom: 1px solid #d1d5db; }
                            .border-t { border-top: 1px solid #d1d5db; }
                            .border-collapse { border-collapse: collapse; }
                            .w-full { width: 100%; }
                            .w-64 { width: 16rem; }
                            .h-16 { height: 4rem; }
                            .text-left { text-align: left; }
                            .text-center { text-align: center; }
                            .text-right { text-align: right; }
                            .flex { display: flex; }
                            .justify-between { justify-content: space-between; }
                            .justify-center { justify-content: center; }
                            .justify-end { justify-content: flex-end; }
                            .items-start { align-items: flex-start; }
                            .bg-gray-50 { background-color: #f9fafb; }
                            table { width: 100%; border-collapse: collapse; }
                            th, td { border: 1px solid #d1d5db; padding: 8px; }
                            th { background-color: #f9fafb; }
                        </style>
                    </head>
                    <body>
                        ${content.innerHTML}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        };

        window.downloadInvoicePDF = function(invoiceId) {
            const invoice = appData.invoices.find(inv => inv.id === invoiceId);
            const client = appData.clients.find(c => c.id === invoice.clientId);
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Set font
            doc.setFont('helvetica');
            
            // Header
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text(appData.profile.companyName || 'My Company', 20, 30);
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            if (appData.profile.companyAddress) {
                doc.text(appData.profile.companyAddress, 20, 40);
            }
            if (appData.profile.companyGstin) {
                doc.text(`GSTIN: ${appData.profile.companyGstin}`, 20, 50);
            }
            
            // Invoice details
            doc.setFont('helvetica', 'bold');
            doc.text('INVOICE', 150, 30);
            doc.setFont('helvetica', 'normal');
            doc.text(`Invoice #: ${invoice.invoiceNumber}`, 150, 40);
            doc.text(`Date: ${formatDate(invoice.invoiceDate)}`, 150, 50);
            doc.text(`Due Date: ${formatDate(invoice.dueDate)}`, 150, 60);
            
            // Client details
            doc.setFont('helvetica', 'bold');
            doc.text('Bill To:', 20, 80);
            doc.setFont('helvetica', 'normal');
            doc.text(client?.name || 'Unknown Client', 20, 90);
            if (client?.address) {
                doc.text(client.address, 20, 100);
            }
            if (client?.gstin) {
                doc.text(`GSTIN: ${client.gstin}`, 20, 110);
            }
            
            // Items table
            const tableData = invoice.items?.map(item => [
                item.name,
                item.quantity.toString(),
                formatCurrency(item.price),
                `${item.gstRate}%`,
                formatCurrency(item.quantity * item.price * (1 + item.gstRate / 100))
            ]) || [];
            
            doc.autoTable({
                head: [['Description', 'Qty', 'Rate', 'GST %', 'Amount']],
                body: tableData,
                startY: 130,
                theme: 'striped',
                headStyles: { fillColor: [240, 240, 240], textColor: [0, 0, 0] }
            });
            
            // Totals
            const finalY = doc.lastAutoTable.finalY + 20;
            doc.text(`Subtotal: ${formatCurrency(invoice.subtotal || 0)}`, 130, finalY);
            doc.text(`Total GST: ${formatCurrency(invoice.tax || 0)}`, 130, finalY + 10);
            doc.setFont('helvetica', 'bold');
            doc.text(`Total: ${formatCurrency(invoice.total || 0)}`, 130, finalY + 20);
            
            // Save PDF
            doc.save(`invoice-${invoice.invoiceNumber}.pdf`);
        };

        window.signOutUser = signOutUser;

        // Update UI function
        function updateUI() {
            const app = document.getElementById('app');
            if (currentUser) {
                app.innerHTML = renderMainApp();
                
                // Update invoice search if on invoices page
                if (currentPage === 'invoices') {
                    const searchInput = document.getElementById('invoice-search');
                    if (searchInput) {
                        searchInput.addEventListener('input', () => {
                            const tableBody = document.getElementById('invoices-table-body');
                            if (tableBody) {
                                tableBody.innerHTML = renderInvoicesTable();
                            }
                        });
                    }
                }
                
                // Initialize chart if on dashboard
                if (currentPage === 'dashboard') {
                    setTimeout(initChart, 100);
                }
                
                // Calculate totals if on invoice form
                if (currentPage === 'invoice-form') {
                    setTimeout(() => {
                        document.querySelectorAll('.line-item').forEach((item, index) => {
                            calculateLineTotal(index);
                        });
                    }, 100);
                }
            } else {
                app.innerHTML = renderAuthView();
            }
        }

        function initChart() {
            const canvas = document.getElementById('financial-chart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Calculate last 6 months data
            const months = [];
            const incomeData = [];
            const expenseData = [];
            
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const monthName = date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                months.push(monthName);
                
                // Calculate income for this month
                const monthIncome = appData.invoices
                    .filter(inv => {
                        if (!inv.invoiceDate || inv.status !== 'paid') return false;
                        const invDate = inv.invoiceDate.toDate ? inv.invoiceDate.toDate() : new Date(inv.invoiceDate);
                        return invDate.getMonth() === date.getMonth() && invDate.getFullYear() === date.getFullYear();
                    })
                    .reduce((sum, inv) => sum + (inv.total || 0), 0);
                
                // Calculate expenses for this month
                const monthExpenses = appData.expenses
                    .filter(exp => {
                        if (!exp.date) return false;
                        const expDate = exp.date.toDate ? exp.date.toDate() : new Date(exp.date);
                        return expDate.getMonth() === date.getMonth() && expDate.getFullYear() === date.getFullYear();
                    })
                    .reduce((sum, exp) => sum + (exp.amount || 0), 0);
                
                incomeData.push(monthIncome);
                expenseData.push(monthExpenses);
            }
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Income',
                            data: incomeData,
                            backgroundColor: 'rgba(34, 197, 94, 0.8)',
                            borderColor: 'rgba(34, 197, 94, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Expenses',
                            data: expenseData,
                            backgroundColor: 'rgba(239, 68, 68, 0.8)',
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₹' + value.toLocaleString('en-IN');
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ₹' + context.parsed.y.toLocaleString('en-IN');
                                }
                            }
                        }
                    }
                }
            });
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Auth form listeners
            document.addEventListener('submit', async (e) => {
                if (e.target.id === 'signin-form') {
                    e.preventDefault();
                    const email = document.getElementById('signin-email').value;
                    const password = document.getElementById('signin-password').value;
                    await signIn(email, password);
                } else if (e.target.id === 'signup-form') {
                    e.preventDefault();
                    const email = document.getElementById('signup-email').value;
                    const password = document.getElementById('signup-password').value;
                    const confirmPassword = document.getElementById('signup-confirm-password').value;
                    
                    if (password !== confirmPassword) {
                        showError('Passwords do not match');
                        return;
                    }
                    
                    await signUp(email, password);
                } else if (e.target.id === 'invoice-form') {
                    e.preventDefault();
                    
                    // Collect line items
                    const items = [];
                    document.querySelectorAll('.line-item').forEach(item => {
                        const description = item.querySelector('.description-input').value;
                        const quantity = parseFloat(item.querySelector('.quantity-input').value);
                        const price = parseFloat(item.querySelector('.price-input').value);
                        const gstRate = parseFloat(item.querySelector('.gst-input').value);
                        const productId = item.querySelector('.product-select').value;
                        
                        if (description && quantity && price) {
                            items.push({
                                productId: productId || null,
                                name: description,
                                quantity,
                                price,
                                gstRate
                            });
                        }
                    });
                    
                    if (items.length === 0) {
                        showError('Please add at least one line item');
                        return;
                    }
                    
                    // Calculate totals
                    let subtotal = 0;
                    let tax = 0;
                    
                    items.forEach(item => {
                        const itemSubtotal = item.quantity * item.price;
                        const itemTax = itemSubtotal * (item.gstRate / 100);
                        subtotal += itemSubtotal;
                        tax += itemTax;
                    });
                    
                    const total = subtotal + tax;
                    
                    const invoiceData = {
                        invoiceNumber: document.getElementById('invoice-number').value,
                        clientId: document.getElementById('client-select').value,
                        invoiceDate: Timestamp.fromDate(new Date(document.getElementById('invoice-date').value)),
                        dueDate: Timestamp.fromDate(new Date(document.getElementById('due-date').value)),
                        items,
                        subtotal,
                        tax,
                        total,
                        status: window.editingInvoice?.status || 'pending'
                    };
                    
                    const editingId = window.editingInvoice?.id;
                    await saveInvoice(invoiceData, editingId);
                    navigateTo('invoices');
                } else if (e.target.id === 'settings-form') {
                    e.preventDefault();
                    
                    const profileData = {
                        companyName: document.getElementById('company-name').value,
                        companyAddress: document.getElementById('company-address').value,
                        companyGstin: document.getElementById('company-gstin').value,
                        companyState: document.getElementById('company-state').value,
                        companyLogoUrl: document.getElementById('company-logo').value,
                        companyUpiId: document.getElementById('company-upi').value
                    };
                    
                    await updateProfile(profileData);
                }
            });
        });

        // Auth state listener
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                loadUserData();
            } else {
                updateUI();
            }
        });

        // Initial render
        updateUI();
    </script>
    <style>
        .nav-item {
            @apply flex items-center px-3 py-2 text-sm font-medium rounded-md text-gray-600 hover:bg-gray-50 hover:text-gray-900 transition-colors duration-200;
        }
        .nav-item.active {
            @apply bg-blue-50 text-blue-700 border-r-2 border-blue-500;
        }
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #invoice-content, #invoice-content * {
                visibility: visible;
            }
            #invoice-content {
                position: absolute;
                left: 0;
                top: 0;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>
    
    <!-- Loading spinner -->
    <div id="loading" class="hidden">
        <div class="spinner"></div>
    </div>
</body>
</html>